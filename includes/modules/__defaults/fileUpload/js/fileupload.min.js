(()=>{console.log("Fileupload.js loaded");let e=0,t="",o="";function r(e){e.closest(".upload_div").querySelectorAll(".loadergif_wrapper").forEach((e=>{e.classList.remove("hidden"),e.querySelectorAll(".uploadmessage").forEach((e=>{e.textContent="Preparing upload",e.classList.add("upload-message")}))})),t.insertAdjacentHTML("beforeEnd",' \n\t<div id="progress-wrapper" class="hidden">\n\t\t<progress id="upload_progress" value="0" max="100"></progress>\n\t\t<span id="progress_percentage">   0%</span>\n\t</div>\n\t')}function l(e,o){let r=`\n\t<div class='document'>\n\t\t<input type='hidden' name='${t.querySelector(".file_upload").name.replace("_files","")}' value='${o}'>\n\t\t${e}\n\t\t<img class="remove_document_loader hidden" src="${sim.loadingGif}" style="height:40px;">\n\t</div>`;return t.querySelector(".documentpreview").insertAdjacentHTML("beforeend",r),t.querySelector(".documentpreview .document")}function s(o){if(o.lengthComputable){var r=o.total,l=100*o.loaded/r;l=Math.round(10*l)/10,document.getElementById("upload_progress").value=l,document.getElementById("progress_percentage").textContent=`   ${l}%`,l>=99&&(document.getElementById("progress-wrapper").remove(),t.querySelectorAll(".uploadmessage").forEach((t=>{t.textContent=e>1?"Processing documents":"Processing document"})))}}function a(e){let r=e.target;4==r.readyState&&(r.status>=200&&r.status<400?function(e){let r=JSON.parse(e),s="";for(const e of r){s=e.url;let t=sim.baseUrl+"/"+s,r="",a="";if(null!=e.id&&(o+=' data-libraryid="'+e.id+'"'),r=null==e.id?t:e.id,null!=s.toLowerCase().match(/\.(jpe|jpeg|jpg|gif|png)$/))a=`<a class="fileupload" href="${t}"><img src="${t}" alt="picture" style="width:150px;height:150px;"></a>`;else{let e=t.split("/")[t.split("/").length-1];a=`<a class="fileupload" href="${t}">${e}</a>`}a+=`<button type="button" class="remove_document button" data-url="${s}" ${o}>X</button>`,l(a,r)}if(1==r.length){let e=s.split("/")[s.split("/").length-1];Main.displayMessage(`The file ${e} has been uploaded succesfully.`,"success",!0)}else Main.displayMessage("The files have been uploaded succesfully.","success",!0);t.querySelector(".file_upload").multiple||t.querySelector(".upload_div").classList.add("hidden");const a=new Event("uploadfinished");t.dispatchEvent(a)}(r.responseText):(console.error(r.responseText),Main.displayMessage(JSON.parse(r.responseText).error,"error")),document.querySelectorAll(".loadergif_wrapper").forEach((function(e){e.classList.add("hidden")})),t.querySelector(".file_upload").value="",document.querySelectorAll(".button.form_submit[disabled]").forEach((e=>e.disabled=!1)))}async function n(o){var r,s=new vimeoUploader.VimeoUpload(o),a=await s.tusUploader();if(!a)return t.querySelector(".file_upload").value="",document.getElementById("progress-wrapper").remove(),document.querySelector(".loadergif_wrapper:not(.hidden)").classList.add("hidden"),!1;r=e>1?"s":"",a.options.onProgress=function(e,t){var o=(e/t*100).toFixed(2);document.getElementById("upload_progress").value=o,document.getElementById("progress_percentage").textContent=`   ${o}%`,o>98&&(document.querySelector(".upload-message").textContent="Processing video"+r,document.getElementById("progress-wrapper").classList.add("hidden"))},a.options.onSuccess=async function(){let e=s.storedEntry.postId,r=new FormData;r.append("post_id",e);let a=new XMLHttpRequest;a.open("POST",`${sim.baseUrl}/wp-json${sim.restApiPrefix}/vimeo/add_uploaded_vimeo`,!1),a.send(r),document.getElementById("progress-wrapper").remove();var n=l(`\n\t\t<div class="vimeo-wrapper">\n\t\t\t<div class='vimeo-embed-container loading'>\n\t\t\t\t<iframe src='https://player.vimeo.com/video/${s.storedEntry.vimeoId}' frameborder='0' webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe><br>\n\t\t\t</div>\n\t\t</div>`,e);document.querySelector(".loadergif_wrapper:not(.hidden)").classList.add("hidden"),Main.displayMessage(`The file ${o.name} has been uploaded succesfully.`,"success",!0),t.querySelector(".file_upload").multiple||t.querySelector(".upload_div").classList.add("hidden"),t.querySelector(".file_upload").value="",s.urlStorage.removeUpload(s.storedEntry.urlStorageKey);var d=document.getElementById("postform");null!=d&&(d.querySelector('[name="update"]').value="true",d.querySelector('[name="post_id"]').value=e);for(var i="";!i.ok;)await new Promise((e=>setTimeout(e,1e4))),i=await fetch(`https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/${s.storedEntry.vimeoId}`,{method:"GET"});var u=await i.json();n.querySelector(".vimeo-wrapper").innerHTML=DOMPurify.sanitize(u.html)},a.options.onError=function(e){console.error("Failed because: "+e)},document.querySelector(".upload-message").textContent="Uploading video"+r+" to Vimeo",document.getElementById("progress-wrapper").classList.remove("hidden"),a.start()}window.addEventListener("click",(function(e){var o=e.target;o.matches(".remove_document")&&(e.preventDefault(),async function(e){let o=new FormData;for(let t in e.dataset)""!=e.dataset[t]&&o.append(t,e.dataset[t]);e.style.display="none",e.parentNode.classList.add("removethisdocument"),e.parentNode.querySelector(".remove_document_loader").classList.remove("hidden");let r=await FormSubmit.fetchRestApi("remove_document",o);if(r){let o=e.closest(".document");t=o.closest(".file_upload_wrap"),o.querySelector(".remove_document_loader").classList.add("hidden");try{t.querySelector(".upload_div").classList.remove("hidden")}catch{document.querySelector('[name="post_image_id"]').value=""}o.remove(),t.querySelectorAll(".file_url").forEach(((e,t)=>{e.name=e.name.replace(/(\d)/g,t)})),Main.displayMessage(r)}}(o))})),window.addEventListener("change",(l=>{let d=l.target;d.className.includes("file_upload")&&(l.preventDefault(),async function(l){let d="";if(t=l.closest(".file_upload_wrap"),e=l.files.length,e<0)return void Main.displayMessage("Please select some files before hitting the uplad button!","error");l.closest("form").querySelector(".button.form_submit").disabled=!0;let i=new FormData;i.append("action","upload_files"),o="",l.parentNode.querySelectorAll("input").forEach((e=>{i.append(e.name,e.value),"file"==e.type||e.name.includes("fileupload")||(o+=`data-${e.name}="${e.value}"`)}));for(let t=0;t<e;t++)if("video"==l.files[t].type.split("/")[0]&&"object"==typeof vimeoUploader)r(l),await n(l.files[t]);else{if(l.files[t].size>sim.maxFileSize)return Main.displayMessage("File too big, max file size is "+parseInt(sim.maxFileSize)/1024/1024+"MB","error"),void(l.value="");i.append("files[]",l.files[t])}if(null==i.get("files[]"))return void(l.closest("form").querySelector(".button.form_submit").disabled=!1);let u=new XMLHttpRequest;u.onreadystatechange=a,u.upload.addEventListener("progress",s,!1),u.open("POST",sim.ajaxUrl,!0),r(l),e>1&&(d="s"),l.closest(".upload_div").querySelector(".uploadmessage").textContent="Uploading document"+d,document.getElementById("progress-wrapper").classList.remove("hidden"),u.send(i)}(d))}))})();
//# sourceMappingURL=fileupload.min.js.map