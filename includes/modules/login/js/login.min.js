(()=>{"use strict";const e=(e,t,a)=>fetch(t,{method:"POST",credentials:"same-origin",redirect:"error",headers:{"Content-Type":"application/json",Accept:"application/json",...a},body:JSON.stringify(e)}),t=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},a=e=>btoa(String.fromCharCode(...e));console.log("Login.js loaded");const r=(({actionUrl:r="/login",actionHeader:n={},optionsUrl:o="/login/options"},i={})=>async s=>{const d=await e(s,o,i),l=await d.json();if(!d.ok)throw l;const c=(e=>(e.challenge=Uint8Array.from(t(e.challenge),(e=>e.charCodeAt(0))),void 0!==e.user&&(e.user={...e.user,id:Uint8Array.from(window.atob(e.user.id),(e=>e.charCodeAt(0)))}),void 0!==e.excludeCredentials&&(e.excludeCredentials=e.excludeCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),void 0!==e.allowCredentials&&(e.allowCredentials=e.allowCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),e))(l),u=await navigator.credentials.get({publicKey:c});document.querySelector("#webauthn_wrapper .status_message").textContent="Verifying...";const m=(e=>{const t={id:e.id,type:e.type,rawId:a(new Uint8Array(e.rawId)),response:{clientDataJSON:a(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(t.response.attestationObject=a(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(t.response.authenticatorData=a(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(t.response.signature=a(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(t.response.userHandle=a(new Uint8Array(e.response.userHandle))),t})(u),p=await e(m,r,n),g=await p.text();if(!p.ok)throw JSON.parse(g);return""!==g?JSON.parse(g):g})({actionUrl:sim.base_url+"/wp-json/sim/v1/auth_finish",optionsUrl:sim.base_url+"/wp-json/sim/v1/auth_start",actionHeader:{"X-WP-Nonce":sim.restnonce}},{"X-WP-Nonce":sim.restnonce});function n(e){document.querySelector("#login_wrapper .message").innerHTML=e}let o=!1;function i(e){e.includes("email")&&async function(){n("Sending e-mail... <img id='loader' src='"+sim.loading_gif+"' style='height:30px;margin-top:-6px;float:right;'>");var e=document.getElementById("username").value,t=new FormData;t.append("action","request_email_code"),t.append("username",e);var a=await fetch(sim.ajax_url,{method:"POST",credentials:"same-origin",body:t}),r=await a.text();a.ok?n(r):display_message(r,"error")}();for(var t=0;t<e.length;t++)if("webauthn"!=e[t]){var a=document.getElementById(e[t]+"_wrapper");null!=a&&(a.classList.remove("hidden"),a.querySelectorAll("input").forEach((e=>window.setTimeout((()=>e.focus()),0))))}document.querySelector("#login_button").disabled="",document.querySelector("#submit_login_wrapper").classList.remove("hidden")}function s(e){document.getElementById("webauthn_wrapper").classList.remove("hidden"),r({user_login:document.getElementById("username").value}).then((e=>{l()})).catch((t=>{if(document.getElementById("logging_in_wrapper").classList.add("hidden"),document.querySelector("#webauthn_wrapper").classList.add("hidden"),1==e.length)n("Authentication failed, please setup an additional login factor."),l();else{if("No authenticator available"==t.message)var a="No biometric login for this device found. <br>Give verification code.";else a="Web authentication failed, please give verification code.",a+='<button type="button" class="button small" id="retry_webauthn" style="float:right;margin-top:-20px;">Retry</button>',console.error("Authentication failure: "+t.message);n(a),i(e)}}))}async function d(){var e=document.getElementById("username").value,t=document.getElementById("password").value;if(""!=e&&""!=t){document.querySelector("#check_cred_wrapper .loadergif").classList.remove("hidden"),await waitForInternet();var a=new FormData;a.append("action","check_cred"),a.append("username",e),a.append("password",t);var r=await fetch(sim.ajax_url,{method:"POST",credentials:"same-origin",body:a});console.log(r);var d,c=await r.text();if(r.ok)try{var u=JSON.parse(c);d=u,document.querySelector("#check_cred_wrapper .loadergif").classList.add("hidden"),"string"==typeof d&&0!=d?(document.querySelectorAll("#usercred_wrapper, #login_nav").forEach((e=>e.classList.add("hidden"))),document.getElementById("logging_in_wrapper").classList.remove("hidden"),location.href!=d?location.href=d:hide_modals()):0==d?null==document.querySelector(".invalidcred")&&n("Invalid username or password!"):"object"==typeof d?(document.querySelectorAll("#usercred_wrapper, #login_nav").forEach((e=>e.classList.add("hidden"))),n(""),d.find((e=>"webauthn"==e))?o?s(d):1==d.length?(n("You do not have a valid second login method for this device, please add one."),l()):i(d):i(d)):location.reload()}catch(e){location.href=c}else display_message(u,"error")}else null==document.querySelector(".missingcred")&&n("Please give an username and password!")}async function l(){document.querySelectorAll(".authenticator_wrapper:not(.hidden)").forEach((e=>e.classList.add("hidden"))),document.getElementById("logging_in_wrapper").classList.remove("hidden");var e=document.getElementById("loginform"),t=new FormData(e);if(e.querySelectorAll(".hidden [required]").forEach((e=>{e.required=!1})),e.reportValidity(),0!=e.checkValidity()){await waitForInternet();var a=await fetch(sim.ajax_url,{method:"POST",credentials:"same-origin",body:t}),r=await a.text();a.ok?(document.querySelector("#logging_in_wrapper .status_message").textContent="Succesfully logged in, redirecting...","Login successful"==r?location.reload():location.href=r):(document.querySelectorAll(".authenticator_wrapper input").forEach((e=>{""!=e.value&&(e.closest(".authenticator_wrapper").classList.remove("hidden"),e.value="")})),document.getElementById("logging_in_wrapper").classList.add("hidden"),document.getElementById("logging_in_wrapper").classList.add("hidden"),n(r))}}function c(){m(),document.querySelectorAll("#site-navigation, #mobile-menu-control-wrapper").forEach((e=>e.classList.remove("toggled"))),document.querySelector("body").classList.remove("mobile-menu-open"),document.querySelector("#mobile-menu-control-wrapper > button").ariaExpanded="false",document.querySelector("body").style.overflowY="hidden";var e=document.getElementById("login_modal");e.querySelectorAll("form > div:not(.hidden)").forEach((e=>e.classList.add("hidden"))),e.querySelector("#usercred_wrapper").classList.remove("hidden"),e.classList.remove("hidden"),window.setTimeout((()=>e.querySelector("#username").focus()),0)}document.addEventListener("keypress",(function(e){"Enter"===e.key&&(document.querySelector("#usercred_wrapper").classList.contains("hidden")?document.querySelector("#submit_login_wrapper").classList.contains("hidden")||l():d())}));var u=new MutationObserver((function(e){e.forEach((function(e){"data-hcaptcha-response"===e.attributeName&&document.querySelector(".h-captcha iframe").dataset.hcaptchaResponse.length>1e3&&p(document.querySelector("#login_nav>a"))}))}));function m(){setTimeout((function(){var e=document.querySelector(".h-captcha iframe");null==e?m():u.observe(e,{attributes:!0})}),1e3)}async function p(e){var t=document.getElementById("username").value;if(""!=t){var a=e.previousElementSibling;if(a.classList.contains("hidden"))null==a.querySelector("iframe")&&display_message("Captcha failed to load, please refresh the page","error"),a.classList.remove("hidden"),e.text="Send password reset request";else{e.classList.add("hidden");var r=showLoader(e,!1,"Sending e-mail...   "),n=new FormData(e.closest("form"));n.append("action","request_pwd_reset"),n.append("username",t);var o=await fetch(sim.ajax_url,{method:"POST",credentials:"same-origin",body:n}),i=await o.text();o.ok?display_message(i,"success"):display_message(i,"error"),r.remove(),e.classList.remove("hidden")}}else display_message("Specify your username first","error")}window.PublicKeyCredential?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e?(console.log("Supported."),o=!0):console.log("WebAuthn supported, Platform Authenticator not supported.")})).catch((e=>console.log("Something went wrong."))):console.log("Not supported."),document.addEventListener("click",(function(e){var t=e.target;"login_button"==t.id?l():"check_cred"==t.id?d():"toggle_pwd_view"==t.id||"toggle_pwd_view"==t.parentNode.id?function(e){if("IMG"==e.target.tagName)var t=e.target.parentNode;else t=e.target;"0"==t.dataset.toggle?(t.title="Hide password",t.dataset.toggle="1",t.innerHTML=t.innerHTML.replace("invisible","visible"),document.getElementById("password").type="text"):(t.title="Show password",t.dataset.toggle="0",t.innerHTML=t.innerHTML.replace("visible","invisible"),document.getElementById("password").type="password")}(e):"login"==t.id||"login"==t.parentNode.id?c():"lost_pwd_link"==t.id?p(t):"retry_webauthn"==t.id&&(n(""),s([]))})),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(()=>{const e=document.querySelector("meta[name=viewport]");if(null!==e){let t=e.getAttribute("content"),a=/maximum\-scale=[0-9\.]+/g;t=a.test(t)?t.replace(a,"maximum-scale=1.0"):[t,"maximum-scale=1.0"].join(", "),e.setAttribute("content",t)}})()})();
//# sourceMappingURL=login.min.js.map