(()=>{"use strict";async function e(e,t,r=!0){let a;t.append("_wpnonce",sim.restNonce);let n=await fetch(`${sim.baseUrl}/wp-json${sim.restApiPrefix}/login/${e}`,{method:"POST",credentials:"same-origin",body:t});try{a=await n.json()}catch(e){return console.error(e),!1}return n.ok?a:"rest_cookie_invalid_nonce"==a.code?(Main.displayMessage("Please refresh the page and try again!","error"),console.error(a),console.error(`/login/${e}`),!1):(console.error(a),r&&Main.displayMessage(a.message,"error"),console.error(`/login/${e}`),!1)}const t=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},r=e=>btoa(String.fromCharCode(...e));async function a(){document.querySelectorAll(".authenticator_wrapper:not(.hidden)").forEach((e=>{e.classList.add("hidden"),e.classList.add("current-method")})),document.getElementById("logging_in_wrapper").classList.remove("hidden");var t=document.getElementById("loginform"),r=new FormData(t);if(t.querySelectorAll(".hidden [required]").forEach((e=>{e.required=!1})),t.reportValidity()){await Main.waitForInternet();var a=await e("request_login",r);a?(document.querySelector("#logging_in_wrapper .status_message").textContent="Succesfully logged in, redirecting...",a.startsWith("http")?location.href=a:location.reload()):(document.getElementById("logging_in_wrapper").classList.add("hidden"),document.querySelector(".current-method").classList.remove("hidden"))}}async function n(n){document.getElementById("webauthn_wrapper").classList.remove("hidden");var o=document.getElementById("username").value;try{var i=new FormData;i.append("username",o);var d=await e("auth_start",i);if(!d)throw new Error("auth_start failed");var l=(e=>(e.challenge=Uint8Array.from(t(e.challenge),(e=>e.charCodeAt(0))),void 0!==e.user&&(e.user={...e.user,id:Uint8Array.from(window.atob(e.user.id),(e=>e.charCodeAt(0)))}),void 0!==e.excludeCredentials&&(e.excludeCredentials=e.excludeCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),void 0!==e.allowCredentials&&(e.allowCredentials=e.allowCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),e))(d);document.querySelector("#webauthn_wrapper .status_message").textContent="Waiting for biometric";var u=await navigator.credentials.get({publicKey:l});document.querySelector("#webauthn_wrapper .status_message").textContent="Verifying...";const n=(e=>{const t={id:e.id,type:e.type,rawId:r(new Uint8Array(e.rawId)),response:{clientDataJSON:r(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(t.response.attestationObject=r(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(t.response.authenticatorData=r(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(t.response.signature=r(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(t.response.userHandle=r(new Uint8Array(e.response.userHandle))),t})(u);if((i=new FormData).append("publicKeyCredential",JSON.stringify(n)),!(d=await e("auth_finish",i)))throw new Error("auth_finish failed");a()}catch(e){var m;document.getElementById("logging_in_wrapper").classList.add("hidden"),document.querySelector("#webauthn_wrapper").classList.add("hidden"),1==n.length?(s("Authentication failed, please setup an additional login factor."),a()):("No authenticator available"==e.message?m="No biometric login for this device found. <br>Give verification code.":(m="Web authentication failed, please give verification code.",m+='<button type="button" class="button small" id="retry_webauthn" style="float:right;margin-top:-20px;">Retry</button>',console.error("Authentication failure: "+e.message)),s(m),c(n))}}async function o(){var t=document.getElementById("username").value,r=document.getElementById("password").value;if(""!=t&&""!=r){document.querySelector("#check_cred_wrapper .loadergif").classList.remove("hidden"),await Main.waitForInternet();var o=new FormData;o.append("username",t),o.append("password",r);var i,l=await e("check_cred",o);l&&("false"==l?(s("Invalid login, try again"),document.getElementById("captcha-form").classList.remove("hidden"),document.querySelector("#check_cred_wrapper .loadergif").classList.add("hidden")):(i=l,document.querySelector("#check_cred_wrapper .loadergif").classList.add("hidden"),"string"==typeof i&&i?(document.querySelectorAll("#usercred_wrapper, #captcha-form").forEach((e=>e.classList.add("hidden"))),document.getElementById("logging_in_wrapper").classList.remove("hidden"),location.href!=i?location.href=i:Main.hideModals()):i?"object"==typeof i?(document.querySelectorAll("#usercred_wrapper, #captcha-form").forEach((e=>e.classList.add("hidden"))),s(""),i.find((e=>"webauthn"==e))?d?n(i):1==i.length?(s("You do not have a valid second login method for this device, please add one."),a()):c(i):c(i)):location.reload():s("Invalid username or password!")))}else s("Please give an username and password!")}async function i(t){var r=document.getElementById("username").value;if(""==r)return void Main.displayMessage("Specify your username first","error");let a=document.getElementById("captcha-form");if(a.classList.contains("hidden"))null==captcha.querySelector("iframe")&&Main.displayMessage("Captcha failed to load, please refresh the page","error"),a.classList.remove("hidden"),t.text="Send password reset request";else{t.classList.add("hidden");var n=Main.showLoader(t,!1,"Sending e-mail...   "),o=new FormData;o.append("username",r);var i=await e("request_pwd_reset",o);i&&Main.displayMessage(i,"success"),n.remove(),t.classList.remove("hidden")}}function s(e){document.querySelector("#login_wrapper .message").innerHTML=DOMPurify.sanitize(e)}console.log("Login.js loaded");let d=!1;function c(t){t.includes("email")&&async function(){s("Sending e-mail... <img id='loader' src='"+sim.loadingGif+"' style='height:30px;margin-top:-6px;float:right;'>");var t=document.getElementById("username").value,r=new FormData;r.append("username",t),s(await e("request_email_code",r,!1)||"Sending e-mail failed")}();for(const e of t)if("webauthn"!=e){var r=document.getElementById(e+"_wrapper");null!=r&&(r.classList.remove("hidden"),r.querySelectorAll("input").forEach((e=>window.setTimeout((()=>e.focus()),0))))}document.querySelector("#login_button").disabled="",document.querySelector("#submit_login_wrapper").classList.remove("hidden")}function l(){m(),document.querySelectorAll("#site-navigation, #mobile-menu-control-wrapper").forEach((e=>e.classList.remove("toggled"))),document.querySelector("body").classList.remove("mobile-menu-open"),document.querySelector("#mobile-menu-control-wrapper > button").ariaExpanded="false",document.querySelector("body").style.overflowY="hidden";var e=document.getElementById("login_modal");e.querySelectorAll("form > div:not(.hidden)").forEach((e=>e.classList.add("hidden"))),e.querySelector("#usercred_wrapper").classList.remove("hidden"),e.classList.remove("hidden"),window.setTimeout((()=>e.querySelector("#username").focus()),0)}document.addEventListener("keypress",(function(e){"Enter"===e.key&&(document.querySelector("#usercred_wrapper").classList.contains("hidden")?document.querySelector("#submit_login_wrapper").classList.contains("hidden")||a():o())}));var u=new MutationObserver((function(e){e.forEach((function(e){"data-hcaptcha-response"===e.attributeName&&document.querySelector(".h-captcha iframe").dataset.hcaptchaResponse.length>1e3&&i(document.querySelector("#captcha-form>a"))}))}));function m(){null!=document.querySelector(".h-captcha")&&setTimeout((function(){var e=document.querySelector(".h-captcha iframe");null==e?m():u.observe(e,{attributes:!0})}),1e3)}window.PublicKeyCredential?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e?(console.log("Supported."),d=!0):console.log("WebAuthn supported, Platform Authenticator not supported.")})).catch((e=>{console.error("Something went wrong."),console.error(e)})):console.log("Not supported."),document.addEventListener("click",(function(t){var r=t.target;r.matches(".login")?l():"check_cred"==r.id?o():"login_button"==r.id?a():null!=r.closest(".toggle_pwd_view")?function(e){var t=e.target;"IMG"==e.target.tagName&&(t=e.target.parentNode),"0"==t.dataset.toggle?(t.title="Hide password",t.dataset.toggle="1",t.innerHTML=t.innerHTML.replace("invisible","visible"),t.closest(".password").querySelector('input[type="password"]').type="text"):(t.title="Show password",t.dataset.toggle="0",t.innerHTML=t.innerHTML.replace("visible","invisible"),t.closest(".password").querySelector('input[type="text"]').type="password")}(t):"lost_pwd_link"==r.id?i(r):"retry_webauthn"==r.id?(s(""),n([])):"request_account"==r.name&&async function(t){var r=t.closest("form");r.querySelector(".loadergif").classList.remove("hidden");var a=new FormData(r),n=await e("request_user_account",a);n&&Main.displayMessage(n),r.reset(),r.querySelector(".loadergif").classList.add("hidden")}(r)})),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(()=>{const e=document.querySelector("meta[name=viewport]");if(null!==e){let t=e.getAttribute("content"),r=/maximum\-scale=[0-9\.]+/g;t=r.test(t)?t.replace(r,"maximum-scale=1.0"):[t,"maximum-scale=1.0"].join(", "),e.setAttribute("content",t)}})(),document.querySelectorAll(".login").forEach((e=>{e.classList.remove("hidden")}))})();
//# sourceMappingURL=login.min.js.map