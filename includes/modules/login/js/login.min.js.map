{"version":3,"file":"login.min.js","mappings":"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","sources":["webpack://login/./node_modules/@web-auth/webauthn-helper/src/common.js","webpack://login/./login.js","webpack://login/./node_modules/@web-auth/webauthn-helper/src/useLogin.js","webpack://login/./shared.js"],"sourcesContent":["// Predefined fetch function\nexport const fetchEndpoint = (data, url, header) => {\n  return fetch(\n      url,\n      {\n        method: 'POST',\n        credentials: 'same-origin',\n        redirect: 'error',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json',\n          ...header\n        },\n        body: JSON.stringify(data),\n      }\n  );\n} \n\n\n// Decodes a Base64Url string\nconst base64UrlDecode = (input) => {\n  input = input\n      .replace(/-/g, '+')\n      .replace(/_/g, '/');\n\n  const pad = input.length % 4;\n  if (pad) {\n    if (pad === 1) {\n      throw new Error('InvalidLengthError: Input base64url string is the wrong length to determine padding');\n    }\n    input += new Array(5-pad).join('=');\n  }\n\n  return window.atob(input);\n};\n\n// Converts an array of bytes into a Base64Url string\nconst arrayToBase64String = (a) => btoa(String.fromCharCode(...a));\n\n// Prepares the public key options object returned by the Webauthn Framework\nexport const preparePublicKeyOptions = publicKey => {\n  //Convert challenge from Base64Url string to Uint8Array\n  publicKey.challenge = Uint8Array.from(\n      base64UrlDecode(publicKey.challenge),\n      c => c.charCodeAt(0)\n  );\n\n  //Convert the user ID from Base64 string to Uint8Array\n  if (publicKey.user !== undefined) {\n    publicKey.user = {\n      ...publicKey.user,\n      id: Uint8Array.from(\n          window.atob(publicKey.user.id),\n          c => c.charCodeAt(0)\n      ),\n    };\n  }\n\n  //If excludeCredentials is defined, we convert all IDs to Uint8Array\n  if (publicKey.excludeCredentials !== undefined) {\n    publicKey.excludeCredentials = publicKey.excludeCredentials.map(\n        data => {\n          return {\n            ...data,\n            id: Uint8Array.from(\n                base64UrlDecode(data.id),\n                c => c.charCodeAt(0)\n            ),\n          };\n        }\n    );\n  }\n\n  if (publicKey.allowCredentials !== undefined) {\n    publicKey.allowCredentials = publicKey.allowCredentials.map(\n        data => {\n          return {\n            ...data,\n            id: Uint8Array.from(\n                base64UrlDecode(data.id),\n                c => c.charCodeAt(0)\n            ),\n          };\n        }\n    );\n  }\n\n  return publicKey;\n};\n\n// Prepares the public key credentials object returned by the authenticator\nexport const preparePublicKeyCredentials = data => {\n  const publicKeyCredential = {\n    id: data.id,\n    type: data.type,\n    rawId: arrayToBase64String(new Uint8Array(data.rawId)),\n    response: {\n      clientDataJSON: arrayToBase64String(\n          new Uint8Array(data.response.clientDataJSON)\n      ),\n    },\n  };\n\n  if (data.response.attestationObject !== undefined) {\n    publicKeyCredential.response.attestationObject = arrayToBase64String(\n        new Uint8Array(data.response.attestationObject)\n    );\n  }\n\n  if (data.response.authenticatorData !== undefined) {\n    publicKeyCredential.response.authenticatorData = arrayToBase64String(\n        new Uint8Array(data.response.authenticatorData)\n    );\n  }\n\n  if (data.response.signature !== undefined) {\n    publicKeyCredential.response.signature = arrayToBase64String(\n        new Uint8Array(data.response.signature)\n    );\n  }\n\n  if (data.response.userHandle !== undefined) {\n    publicKeyCredential.response.userHandle = arrayToBase64String(\n        new Uint8Array(data.response.userHandle)\n    );\n  }\n\n  return publicKeyCredential;\n};\n","import {close_mobile_menu} from './shared.js';\n\n//Add an event listener to the login or register button\nconsole.log(\"Login.js loaded\");\n\n// Import the login hook\nimport useLogin from './node_modules/@web-auth/webauthn-helper/src/useLogin.js';\n\n// function to run webauthn login\nconst request_webauthn = useLogin(\n\t{\n\t\tactionUrl: sim.base_url+'/wp-json/sim/v1/auth_finish',\n\t\toptionsUrl: sim.base_url+'/wp-json/sim/v1/auth_start',\n\t\tactionHeader:{'X-WP-Nonce': sim.restnonce}\n\t},\n\t{\n\t\t'X-WP-Nonce': sim.restnonce\n\t}\n);\n\nfunction show_message(message){\n\tdocument.querySelector(\"#login_wrapper .message\").innerHTML= message;\n}\n\nlet webauthn_supported\t= false;\nfunction check_webauthn_available(){\n\tif (window.PublicKeyCredential) {\n\t\tPublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((available) => {\n\t\t\tif (available) {\n\t\t\t\tconsole.log(\"Supported.\");\n\t\t\t\twebauthn_supported = true;\n\t\t\t} else {\n\t\t\t\tconsole.log(\"WebAuthn supported, Platform Authenticator not supported.\");\n\t\t\t}\n\t\t})\n\t\t.catch((err) => console.log(\"Something went wrong.\"));\n\t} else {\n\t\tconsole.log(\"Not supported.\");\n\t}\n}\n\nfunction show_2fa_code_fields(methods){\n\tif(methods.includes('email')){\n\t\trequest_email_code();\n\t}\n\n\t//show 2fa fields\n\tfor(var x=0; x<methods.length; x++){\n\t\tif(methods[x] == 'webauthn'){\n\t\t\t//do not show webauthn\n\t\t\tcontinue;\n\t\t}\n\t\tvar wrapper\t= document.getElementById(methods[x]+'_wrapper');\n\t\tif(wrapper != null){\n\t\t\twrapper.classList.remove('hidden');\n\t\t\twrapper.querySelectorAll('input').forEach(el=>window.setTimeout(() => el.focus(), 0));\n\t\t}\n\t}\n\n\t//enable login button\n\tdocument.querySelector(\"#login_button\").disabled\t\t\t= '';\n\t//show login button\n\tdocument.querySelector('#submit_login_wrapper').classList.remove('hidden');\n}\n\nfunction verify_webauthn(methods){\t\n\t//show webauthn messages\n\tdocument.getElementById('webauthn_wrapper').classList.remove('hidden');\n\n\t//initiate login\n\trequest_webauthn({\n\t\tuser_login: document.getElementById('username').value,\n\t})\n\t.then((response) => {\n\t\t//authentication success\n\t\trequest_login();\n\t})\n\t.catch((error) => {\n\t\tif(document.getElementById('logging_in_wrapper').classList.add('hidden'));\n\n\t\t//authentication failed\n\t\tdocument.querySelector('#webauthn_wrapper').classList.add('hidden');\n\n\t\tif(methods.length == 1){\n\t\t\tshow_message('Authentication failed, please setup an additional login factor.');\n\t\t\trequest_login();\n\t\t}else{\n\t\t\tif(error['message'] == \"No authenticator available\"){\n\t\t\t\tvar message = \"No biometric login for this device found. <br>Give verification code.\";\n\t\t\t}else{\n\t\t\t\tvar message = 'Web authentication failed, please give verification code.';\n\t\t\t\tmessage += '<button type=\"button\" class=\"button small\" id=\"retry_webauthn\" style=\"float:right;margin-top:-20px;\">Retry</button>';\n\t\t\t\tconsole.error('Authentication failure: '+error['message']);\n\t\t\t}\n\t\t\tshow_message(message);\n\n\t\t\t//Show other 2fa fields\n\t\t\tshow_2fa_code_fields(methods);\n\t\t}\n\t})\n\t;\n}\n\nfunction add_methods(result){\n\tdocument.querySelector('#check_cred_wrapper .loadergif').classList.add('hidden');\n\t\n\tif(typeof(result) == 'string' && result != false){\n\t\t//hide login form\n\t\tdocument.querySelectorAll(\"#usercred_wrapper, #login_nav\").forEach(el=>el.classList.add('hidden'));\n\n\t\tdocument.getElementById('logging_in_wrapper').classList.remove('hidden');\n\n\t\tif(location.href != result){\n\t\t\t//redirect to the returned webpage\n\t\t\tlocation.href\t= result;\n\t\t}else{\n\t\t\t//close login modal\n\t\t\thide_modals();\n\t\t}\n\t}else if(result == false){\n\t\t//incorrect creds add message, but only once\n\t\tif(document.querySelector('.invalidcred') == null){\n\t\t\tshow_message('Invalid username or password!');\n\t\t}\n\t}else if(typeof(result) == 'object'){\n\t\t//hide cred fields\n\t\tdocument.querySelectorAll(\"#usercred_wrapper, #login_nav\").forEach(el=>el.classList.add('hidden'));\n\n\t\t//hide messsages\n\t\tshow_message('');\n\n\t\tif(result.find(element => element == 'webauthn')){\n\t\t\tif(webauthn_supported){\n\t\t\t\t//correct creds and webauthn enabled\n\t\t\t\tverify_webauthn(result);\n\t\t\t}else if(result.length == 1){\n\t\t\t\tshow_message('You do not have a valid second login method for this device, please add one.');\n\t\t\t\trequest_login();\n\t\t\t}else{\n\t\t\t\tshow_2fa_code_fields(result);\n\t\t\t}\n\t\t}else{\n\t\t\t//correct creds and 2fa enabled\n\t\t\tshow_2fa_code_fields(result);\n\t\t}\n\t}else{\n\t\t//something went wrong, reload the page\n\t\tlocation.reload();\n\t}\n}\n\nasync function request_email_code(){\n\t//add new one\n\tvar loader\t\t\t\t= \"<img id='loader' src='\"+sim.loading_gif+\"' style='height:30px;margin-top:-6px;float:right;'>\";\n\tshow_message(`Sending e-mail... ${loader}`);\n\n\tvar username\t= document.getElementById('username').value;\n\tvar formData\t= new FormData();\n\tformData.append('action','request_email_code');\n\tformData.append('username',username);\n\n \tvar response = await fetch(sim.ajax_url, {\n\t\tmethod: 'POST',\n\t\tcredentials: 'same-origin',\n\t\tbody: formData\n\t});\n\n\tvar message = await response.text();\n\t\n\tif(response.ok){\n\t\tshow_message(message);\n\t}else{\n\t\tdisplay_message(message, 'error');\n\t}\n}\n\nasync function verify_creds(){\n\tvar username\t= document.getElementById('username').value;\n\tvar password\t= document.getElementById('password').value;\n\tif(username != '' && password != ''){\n\t\tdocument.querySelector('#check_cred_wrapper .loadergif').classList.remove('hidden');\n\t}else{\n\t\tif(document.querySelector('.missingcred') == null){\n\t\t\tshow_message('Please give an username and password!');\n\t\t}\n\t\treturn;\n\t}\n\n\tawait waitForInternet();\n\n\tvar formData\t= new FormData();\n\tformData.append('action','check_cred');\n\tformData.append('username',username);\n\tformData.append('password',password);\n\n \tvar response = await fetch(sim.ajax_url, {\n\t\tmethod: 'POST',\n\t\tcredentials: 'same-origin',\n\t\tbody: formData\n\t});\n\n\tvar text = await response.text();\n\t\n\tif(response.ok){\n\t\ttry {\n\t\t\tvar methods = JSON.parse(text);\n\t\t\tadd_methods(methods);\n\t\t} catch (e) {\n\t\t\tlocation.href=text;\n\t\t}\n\t}else{\n\t\tdisplay_message(text, 'error');\n\t\thide_modals();\n\t}\n}\n\n//show loader\nasync function request_login(){\n\t//hide everything\n\tdocument.querySelectorAll('.authenticator_wrapper:not(.hidden)').forEach(el=>el.classList.add('hidden'));\n\t\n\t//show login messages\n\tdocument.getElementById('logging_in_wrapper').classList.remove('hidden');\n\n\tvar form \t\t= document.getElementById('loginform');\n\tvar formData\t= new FormData(form);\n\tform.querySelectorAll('.hidden [required]').forEach(el=>{el.required = false});\n\tform.reportValidity();\n\t//if not valid return\n\tif(form.checkValidity() == false){\n\t\treturn;\n\t}\n\n\tawait waitForInternet();\n\n\tvar response = await fetch(sim.ajax_url, {\n\t\tmethod: 'POST',\n\t\tcredentials: 'same-origin',\n\t\tbody: formData\n\t});\n\n\tvar message = await response.text();\n\n\tif(response.ok){\n\t\tdocument.querySelector('#logging_in_wrapper .status_message').textContent='Succesfully logged in, redirecting...';\n\t\t\n\t\tif(message == 'Login successful'){\n\t\t\tlocation.reload();\n\t\t}else{\n\t\t\tlocation.href = message;\n\t\t}\n\t}else{\n\t\tdocument.querySelectorAll('.authenticator_wrapper input').forEach(el=>{\n\t\t\tif(el.value != ''){\n\t\t\t\tel.closest('.authenticator_wrapper').classList.remove('hidden');\n\t\t\t\tel.value\t= '';\n\t\t\t}\n\t\t})\n\t\tdocument.getElementById('logging_in_wrapper').classList.add('hidden');\n\t\tdocument.getElementById('logging_in_wrapper').classList.add('hidden');\n\t\tshow_message(message,'error');\n\t}\n};\n\ndocument.addEventListener('keypress', function (e) {\n    if (e.key === 'Enter'){\n\t\tif(!document.querySelector(\"#usercred_wrapper\").classList.contains('hidden')) {\n\t\t\tverify_creds(e);\n\t\t}else if(!document.querySelector(\"#submit_login_wrapper\").classList.contains('hidden')){\n\t\t\trequest_login();\n\t\t}\n\t}\n});\n\nfunction toggle_pwd_view(ev){\n\tif(ev.target.tagName == 'IMG'){\n\t\tvar target\t= ev.target.parentNode;\n\t}else{\n\t\tvar target\t= ev.target;\n\t}\n\n\tif(target.dataset.toggle == '0'){\n\t\ttarget.title\t\t\t\t\t\t\t\t= 'Hide password';\n\t\ttarget.dataset.toggle\t\t\t\t\t\t= '1';\n\t\ttarget.innerHTML\t\t\t\t\t\t\t= target.innerHTML.replace('invisible', 'visible');\n\t\tdocument.getElementById('password').type\t= 'text';\n\t}else{\n\t\ttarget.title\t\t\t\t\t\t\t\t= 'Show password';\n\t\ttarget.dataset.toggle\t\t\t\t\t\t= '0';\n\t\ttarget.innerHTML\t\t\t\t\t\t\t= target.innerHTML.replace('visible', 'invisible');\n\t\tdocument.getElementById('password').type\t= 'password';\n\t}\n};\n\nfunction open_login_modal(){\n\twaitforcaptcha();\n\n\tclose_mobile_menu();\n\n\t//prevent page scrolling\n\tdocument.querySelector('body').style.overflowY = 'hidden';\n\n\tvar modal\t= document.getElementById('login_modal');\n\n\t//reset form\n\tmodal.querySelectorAll('form > div:not(.hidden)').forEach(el=>el.classList.add('hidden'));\n\tmodal.querySelector('#usercred_wrapper').classList.remove('hidden');\n\n\tmodal.classList.remove('hidden');\n\n\twindow.setTimeout(() => modal.querySelector('#username').focus(), 0);\n}\n\nvar observer = new MutationObserver(function(mutations) {\n\tmutations.forEach(function(mutation) {\n\t\tif (mutation.attributeName === \"data-hcaptcha-response\" && document.querySelector('.h-captcha iframe').dataset.hcaptchaResponse.length > 1000) {\n\t\t\treset_password(document.querySelector('#login_nav>a'));\n\t\t}\n\t});\n});\n\nfunction waitforcaptcha(){\n\tsetTimeout(function() {\n\t\tvar iframe\t= document.querySelector('.h-captcha iframe');\n\t\tif(iframe\t== null){\n\t\t\twaitforcaptcha();\n\t\t}else{\n\t\t\tobserver.observe(iframe, {\n\t\t\t\tattributes: true\n\t\t\t});\n\t\t}\n\t}, 1000);\n}\n\n//request password reset e-mail\nasync function reset_password(target){\n\tvar username\t= document.getElementById('username').value;\n\n\tif(username == ''){\n\t\tdisplay_message('Specify your username first','error');\n\t\treturn;\n\t}\n\tvar captcha\t= target.previousElementSibling;\n\t//check if captcha visible\n\tif(captcha.classList.contains('hidden')){\n\t\tif(captcha.querySelector('iframe') == null){\n\t\t\tdisplay_message('Captcha failed to load, please refresh the page','error');\n\t\t}\n\n\t\t//show captcha\n\t\tcaptcha.classList.remove('hidden');\n\n\t\t//change button text\n\t\ttarget.text\t= 'Send password reset request';\n\t}else{\n\t\ttarget.classList.add('hidden');\n\t\tvar loader = showLoader(target, false, 'Sending e-mail...   ');\n\n\t\tvar formData\t= new FormData(target.closest('form'));\n\t\tformData.append('action','request_pwd_reset');\n\t\tformData.append('username',username);\n\n\t\tvar response = await fetch(sim.ajax_url, {\n\t\t\tmethod: 'POST',\n\t\t\tcredentials: 'same-origin',\n\t\t\tbody: formData\n\t\t});\n\n\t\tvar message = await response.text();\n\n\t\tif (response.ok) {\n\t\t\tdisplay_message(message,'success');\n\t\t}else{\n\t\t\tdisplay_message(message,'error');\n\t\t}\n\n\t\tloader.remove();\n\t\ttarget.classList.remove('hidden');\n\t}\n};\n\n//check if the current device supports webauthn\ncheck_webauthn_available();\n\ndocument.addEventListener(\"click\", function(event){\n\tvar target = event.target;\n\n\tif(target.id == \"login_button\"){\n\t\trequest_login();\n\t}else if(target.id == 'check_cred'){\n\t\tverify_creds();\n\t}else if(target.id == 'toggle_pwd_view' || target.parentNode.id == 'toggle_pwd_view'){\n\t\ttoggle_pwd_view(event);\n\t}else if(target.id == 'login' || target.parentNode.id == 'login'){\n\t\topen_login_modal();\n\t}else if(target.id == \"lost_pwd_link\"){\n\t\treset_password(target);\n\t}else if(target.id == 'retry_webauthn'){\n\t\tshow_message('');\n\t\tverify_webauthn([]);\n\t}\n});\n\n//prevent zoom in on login form on a iphone\nconst addMaximumScaleToMetaViewport = () => {\n\tconst el = document.querySelector('meta[name=viewport]');\n  \n\tif (el !== null) {\n\t  let content = el.getAttribute('content');\n\t  let re = /maximum\\-scale=[0-9\\.]+/g;\n  \n\t  if (re.test(content)) {\n\t\t  content = content.replace(re, 'maximum-scale=1.0');\n\t  } else {\n\t\t  content = [content, 'maximum-scale=1.0'].join(', ')\n\t  }\n  \n\t  el.setAttribute('content', content);\n\t}\n};\n\nconst checkIsIOS = () =>/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n\nif (checkIsIOS()) {\n\taddMaximumScaleToMetaViewport();\n}","import {\n    fetchEndpoint,\n    preparePublicKeyCredentials,\n    preparePublicKeyOptions,\n} from './common.js';\n\nconst useLogin = ({actionUrl = '/login', actionHeader = {}, optionsUrl = '/login/options'}, optionsHeader = {}) => {\n    return async (data) => {\n        const optionsResponse = await fetchEndpoint(data, optionsUrl, optionsHeader);\n        const json = await optionsResponse.json();\n        if (! optionsResponse.ok) {\n            throw json;\n          } \n        const publicKey = preparePublicKeyOptions(json);\n        const credentials = await navigator.credentials.get({publicKey});\n\t\tdocument.querySelector('#webauthn_wrapper .status_message').textContent\t= 'Verifying...';\n        const publicKeyCredential = preparePublicKeyCredentials(credentials);\n        const actionResponse = await fetchEndpoint(publicKeyCredential, actionUrl, actionHeader);\n        const responseBody = await actionResponse.text();\n        if (! actionResponse.ok) {\n            throw JSON.parse(responseBody);\n        }\n\n        return responseBody !== '' ? JSON.parse(responseBody) : responseBody;\n    };\n};\n\nexport default useLogin;\n","export function close_mobile_menu(){\r\n\t//close mobile menu\r\n\tdocument.querySelectorAll('#site-navigation, #mobile-menu-control-wrapper').forEach(el=>el.classList.remove('toggled'));\r\n\tdocument.querySelector('body').classList.remove('mobile-menu-open');\r\n\tdocument.querySelector(\"#mobile-menu-control-wrapper > button\").ariaExpanded = 'false';\r\n}"],"names":["fetchEndpoint","data","url","header","fetch","method","credentials","redirect","headers","body","JSON","stringify","base64UrlDecode","input","pad","replace","length","Error","Array","join","window","atob","arrayToBase64String","a","btoa","String","fromCharCode","console","log","request_webauthn","actionUrl","actionHeader","optionsUrl","optionsHeader","async","optionsResponse","json","ok","publicKey","challenge","Uint8Array","from","c","charCodeAt","undefined","user","id","excludeCredentials","map","allowCredentials","preparePublicKeyOptions","navigator","get","document","querySelector","textContent","publicKeyCredential","type","rawId","response","clientDataJSON","attestationObject","authenticatorData","signature","userHandle","preparePublicKeyCredentials","actionResponse","responseBody","text","parse","sim","base_url","restnonce","show_message","message","innerHTML","webauthn_supported","show_2fa_code_fields","methods","includes","loading_gif","username","getElementById","value","formData","FormData","append","ajax_url","display_message","request_email_code","x","wrapper","classList","remove","querySelectorAll","forEach","el","setTimeout","focus","disabled","verify_webauthn","user_login","then","request_login","catch","error","add","verify_creds","password","waitForInternet","result","location","href","hide_modals","find","element","reload","e","form","required","reportValidity","checkValidity","closest","open_login_modal","waitforcaptcha","ariaExpanded","style","overflowY","modal","addEventListener","key","contains","observer","MutationObserver","mutations","mutation","attributeName","dataset","hcaptchaResponse","reset_password","iframe","observe","attributes","target","captcha","previousElementSibling","loader","showLoader","PublicKeyCredential","isUserVerifyingPlatformAuthenticatorAvailable","available","err","event","parentNode","ev","tagName","toggle","title","toggle_pwd_view","test","userAgent","MSStream","content","getAttribute","re","setAttribute","addMaximumScaleToMetaViewport"],"sourceRoot":""}