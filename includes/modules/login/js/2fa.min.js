(()=>{"use strict";async function e(e,t){let a;t.append("_wpnonce",sim.restNonce);let r=await fetch(`${sim.baseUrl}/wp-json${sim.restApiPrefix}/login/${e}`,{method:"POST",credentials:"same-origin",body:t});try{a=await r.json()}catch(e){return console.error(e),!1}return r.ok?a:"rest_cookie_invalid_nonce"==a.code?(Main.displayMessage("Please refresh the page and try again!","error"),!1):(console.error(a),Main.displayMessage(a.message,"error"),!1)}const t=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},a=e=>btoa(String.fromCharCode(...e));document.addEventListener("DOMContentLoaded",(function(){console.log("2fa.js loaded"),null!=document.getElementById("webauthn_wrapper")&&(window.PublicKeyCredential?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e?(console.log("Supported."),document.getElementById("webauthn_wrapper").classList.remove("hidden")):console.log("WebAuthn supported, Platform Authenticator not supported.")})).catch((e=>{console.error("Something went wrong."),console.error(e)})):console.log("Not supported."))})),document.addEventListener("click",(r=>{var n=r.target;"2fa_methods[]"==n.name&&function(e){document.querySelectorAll(".twofa_option").forEach((e=>e.classList.add("hidden")));var t=document.getElementById("setup-"+e.value);t.classList.remove("hidden"),Main.isMobileDevice()?t.querySelectorAll(".mobile.hidden").forEach((e=>e.classList.remove("hidden"))):t.querySelectorAll(".desktop.hidden").forEach((e=>e.classList.remove("hidden"))),"authenticator"==e.value&&e.closest("form").querySelector(".form_submit").classList.remove("hidden")}(n),n.matches(".remove_webauthn")&&async function(t){var a=t.closest("table"),r=t.closest("tr"),n=new FormData;n.append("key",t.dataset.key),Main.showLoader(t,!0);var i=await e("remove_web_authenticator",n);i&&(2==a.rows.length?a.remove():r.remove(),Main.displayMessage(i))}(n),"add_fingerprint"==n.id&&async function(r){var n=r.closest("#webauthn_wrapper").querySelector('[name="identifier"]').value;if(""!=n){document.getElementById("add_webauthn").classList.add("hidden");var i=`<div id="loader_wrapper" style='margin-bottom:20px;'><span class="message"></span><img class="loadergif" src="${sim.loadingGif}" height="30px;"></div>`;document.getElementById("add_webauthn").insertAdjacentHTML("afterEnd",i);var o=document.querySelector("#loader_wrapper .message");try{var s=new FormData;s.append("identifier",n);var d=await e("fingerprint_options",s);if(!d)throw new Error("Options retrieval failed");var l=(e=>(e.challenge=Uint8Array.from(t(e.challenge),(e=>e.charCodeAt(0))),void 0!==e.user&&(e.user={...e.user,id:Uint8Array.from(window.atob(e.user.id),(e=>e.charCodeAt(0)))}),void 0!==e.excludeCredentials&&(e.excludeCredentials=e.excludeCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),void 0!==e.allowCredentials&&(e.allowCredentials=e.allowCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),e))(d);o.textContent="Please authenticate...";var c=await navigator.credentials.create({publicKey:l});o.textContent="Saving authenticator...";var m=(e=>{const t={id:e.id,type:e.type,rawId:a(new Uint8Array(e.rawId)),response:{clientDataJSON:a(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(t.response.attestationObject=a(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(t.response.authenticatorData=a(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(t.response.signature=a(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(t.response.userHandle=a(new Uint8Array(e.response.userHandle))),t})(c);if((s=new FormData).append("publicKeyCredential",JSON.stringify(m)),!(d=await e("store_fingerprint",s)))throw new Error("Storing biometric failed");var u=document.getElementById("webautn_devices_wrapper");null==u?document.getElementById("webauthn_wrapper").insertAdjacentHTML("beforeEnd",d):u.outerHTML=d,SimTableFunctions.setTableLabel(),Main.displayMessage("Registration success")}catch(e){document.getElementById("add_webauthn").classList.remove("hidden"),console.error(e)}document.querySelector("#loader_wrapper").remove()}else Main.displayMessage("Please specify a device name","error")}(n),"save2fa"==n.name&&async function(t){var a=t.closest(".submit_wrapper").querySelector(".loadergif");a.classList.remove("hidden");var r=t.closest("form");if(r.querySelectorAll(".hidden [required], select[required]").forEach((e=>{e.required=!1})),r.reportValidity()){var n=new FormData(r),i=await e("save_2fa_settings",n);i&&(r.querySelectorAll('[id^="setup-"]:not(.hidden)').forEach((e=>e.classList.add("hidden"))),Main.displayMessage(i,"success"),t.closest("form").querySelector(".form_submit").classList.add("hidden"))}a.classList.add("hidden")}(n),"email-code-button"==n.id&&async function(t){var a=`<img id='loader' src='${sim.loadingGif}' style='height:30px;margin-top:-6px;float:right;'>`;document.getElementById("email-message").innerHTML=`Sending e-mail... ${a}`;var r=document.getElementById("username").value,n=new FormData;n.append("username",r);var i=await e("request_email_code",n);i&&(document.getElementById("email-message").innerHTML=i,document.getElementById("email-message").classList.add("success"),document.getElementById("email-code-validation").classList.remove("hidden"),t.classList.add("hidden"),t.closest("form").querySelector(".form_submit").classList.remove("hidden"),document.getElementById("email-code-validation").focus())}(n)}))})();
//# sourceMappingURL=2fa.min.js.map