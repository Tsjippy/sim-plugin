(()=>{"use strict";async function e(e,t){t.append("_wpnonce",sim.restnonce);var a=await fetch(sim.base_url+"/wp-json/sim/v1/login/"+e,{method:"POST",credentials:"same-origin",body:t});try{var r=await a.json()}catch(e){return console.error(e),!1}return a.ok?r:(console.error(r),main.displayMessage(r.message,"error"),!1)}const t=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},a=e=>btoa(String.fromCharCode(...e));document.addEventListener("DOMContentLoaded",(function(){console.log("2fa.js loaded"),null!=document.getElementById("webauthn_wrapper")&&(window.PublicKeyCredential?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e?(console.log("Supported."),document.getElementById("webauthn_wrapper").classList.remove("hidden")):console.log("WebAuthn supported, Platform Authenticator not supported.")})).catch((e=>console.log("Something went wrong."))):console.log("Not supported."))})),document.addEventListener("click",(r=>{var n=r.target;"2fa_methods[]"==n.name&&function(e){document.querySelectorAll(".twofa_option").forEach((e=>e.classList.add("hidden")));var t=document.getElementById("setup-"+e.value);t.classList.remove("hidden"),main.isMobileDevice()?t.querySelectorAll(".mobile.hidden").forEach((e=>e.classList.remove("hidden"))):t.querySelectorAll(".desktop.hidden").forEach((e=>e.classList.remove("hidden"))),e.closest("form").querySelector(".form_submit").classList.remove("hidden")}(n),n.matches(".remove_webauthn")&&async function(t){var a=t.closest("table"),r=t.closest("tr"),n=new FormData;n.append("key",t.dataset.key),main.showLoader(t,!0);var o=await e("remove_web_authenticator",n);o&&(2==a.rows.length?a.remove():r.remove(),main.displayMessage(o))}(n),"add_fingerprint"==n.id&&async function(r){var n=r.closest("#webauthn_wrapper").querySelector('[name="identifier"]').value;if(""!=n){document.getElementById("add_webauthn").classList.add("hidden");var o=`<div id="loader_wrapper" style='margin-bottom:20px;'><span class="message"></span><img class="loadergif" src="${sim.loading_gif}" height="30px;"></div>`;document.getElementById("add_webauthn").insertAdjacentHTML("afterEnd",o);var s=document.querySelector("#loader_wrapper .message");try{if((l=new FormData).append("identifier",n),!(c=await e("fingerprint_options",l)))throw"Options retrieval failed";var i=(e=>(e.challenge=Uint8Array.from(t(e.challenge),(e=>e.charCodeAt(0))),void 0!==e.user&&(e.user={...e.user,id:Uint8Array.from(window.atob(e.user.id),(e=>e.charCodeAt(0)))}),void 0!==e.excludeCredentials&&(e.excludeCredentials=e.excludeCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),void 0!==e.allowCredentials&&(e.allowCredentials=e.allowCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),e))(c);s.textContent="Please authenticate...";var d=await navigator.credentials.create({publicKey:i});s.textContent="Saving authenticator...";var l,c,u=(e=>{const t={id:e.id,type:e.type,rawId:a(new Uint8Array(e.rawId)),response:{clientDataJSON:a(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(t.response.attestationObject=a(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(t.response.authenticatorData=a(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(t.response.signature=a(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(t.response.userHandle=a(new Uint8Array(e.response.userHandle))),t})(d);if((l=new FormData).append("publicKeyCredential",JSON.stringify(u)),!(c=await e("store_fingerprint",l)))throw"Storing biometric failed";var m=document.getElementById("webautn_devices_wrapper");null==m?document.getElementById("webauthn_wrapper").insertAdjacentHTML("beforeEnd",c):m.outerHTML=c,setTableLabel(),main.displayMessage("Registration success")}catch(e){document.getElementById("add_webauthn").classList.remove("hidden"),console.error(e)}document.querySelector("#loader_wrapper").remove()}else main.displayMessage("Please specify a device name","error")}(n),"save2fa"==n.name&&async function(t){var a=t.closest(".submit_wrapper").querySelector(".loadergif");a.classList.remove("hidden");var r=t.closest("form"),n=new FormData(r),o=await e("save_2fa_settings",n);o&&(r.querySelectorAll('[id^="setup-"]:not(.hidden)').forEach((e=>e.classList.add("hidden"))),main.displayMessage(o)),a.classList.add("hidden")}(n)}))})();
//# sourceMappingURL=2fa.min.js.map