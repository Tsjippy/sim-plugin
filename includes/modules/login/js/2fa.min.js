(()=>{"use strict";async function e(e,t,r=!0){let a;t.append("_wpnonce",sim.restNonce);let n=await fetch(`${sim.baseUrl}/wp-json${sim.restApiPrefix}/login/${e}`,{method:"POST",credentials:"same-origin",body:t});try{a=await n.json()}catch(e){return console.error(e),!1}return n.ok?a:"rest_cookie_invalid_nonce"==a.code?(Main.displayMessage("Please refresh the page and try again!","error"),console.error(a),console.error(`/login/${e}`),!1):(console.error(a),r&&Main.displayMessage(a.message,"error"),console.error(`/login/${e}`),!1)}const t=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},r=e=>btoa(String.fromCharCode(...e));console.log("2fa.js loaded"),document.addEventListener("DOMContentLoaded",(function(){null!=document.querySelector("#webauthn_wrapper.hidden")&&(window.PublicKeyCredential?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then((e=>{e?(console.log("Supported."),document.getElementById("webauthn_wrapper").classList.remove("hidden")):console.log("WebAuthn supported, Platform Authenticator not supported.")})).catch((e=>{console.error("Something went wrong."),console.error(e)})):console.log("Not supported."))})),document.addEventListener("click",(a=>{var n=a.target;"2fa_methods[]"==n.name&&function(e){document.querySelectorAll(".twofa_option").forEach((e=>e.classList.add("hidden")));var t=document.getElementById("setup-"+e.value);t.classList.remove("hidden"),Main.isMobileDevice()?t.querySelectorAll(".mobile.hidden").forEach((e=>e.classList.remove("hidden"))):t.querySelectorAll(".desktop.hidden").forEach((e=>e.classList.remove("hidden"))),"authenticator"==e.value&&e.closest("form").querySelector(".form_submit").classList.remove("hidden")}(n),n.matches(".remove_webauthn")&&async function(t){var r=t.closest("table"),a=t.closest("tr"),n=new FormData;n.append("key",t.dataset.key),Main.showLoader(t,!0);var o=await e("remove_web_authenticator",n);o&&(2==r.rows.length?r.remove():a.remove(),Main.displayMessage(o))}(n),"add_fingerprint"==n.id&&async function(a){var n=a.closest("#webauthn_wrapper").querySelector('[name="identifier"]').value;if(""!=n){document.getElementById("add_webauthn").classList.add("hidden");var o=`<div id="loader_wrapper" style='margin-bottom:20px;'><span class="message"></span><img class="loadergif" src="${sim.loadingGif}" height="30px;"></div>`;document.getElementById("add_webauthn").insertAdjacentHTML("afterEnd",o);var i=document.querySelector("#loader_wrapper .message");try{var s=new FormData;s.append("identifier",n);var d=await e("fingerprint_options",s);if(!d)throw new Error("Options retrieval failed");var l=(e=>(e.challenge=Uint8Array.from(t(e.challenge),(e=>e.charCodeAt(0))),void 0!==e.user&&(e.user={...e.user,id:Uint8Array.from(window.atob(e.user.id),(e=>e.charCodeAt(0)))}),void 0!==e.excludeCredentials&&(e.excludeCredentials=e.excludeCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),void 0!==e.allowCredentials&&(e.allowCredentials=e.allowCredentials.map((e=>({...e,id:Uint8Array.from(t(e.id),(e=>e.charCodeAt(0)))})))),e))(d);i.textContent="Please authenticate...";var c=await navigator.credentials.create({publicKey:l});i.textContent="Saving authenticator...";var u=(e=>{const t={id:e.id,type:e.type,rawId:r(new Uint8Array(e.rawId)),response:{clientDataJSON:r(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(t.response.attestationObject=r(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(t.response.authenticatorData=r(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(t.response.signature=r(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(t.response.userHandle=r(new Uint8Array(e.response.userHandle))),t})(c);if((s=new FormData).append("publicKeyCredential",JSON.stringify(u)),!(d=await e("store_fingerprint",s)))throw new Error("Storing biometric failed");var m=document.getElementById("webautn_devices_wrapper");null==m?document.getElementById("webauthn_wrapper").insertAdjacentHTML("beforeEnd",d):m.outerHTML=d,SimTableFunctions.setTableLabel(),Main.displayMessage("Registration success")}catch(e){document.getElementById("add_webauthn").classList.remove("hidden"),console.error(e)}document.querySelector("#loader_wrapper").remove()}else Main.displayMessage("Please specify a device name","error")}(n),"save2fa"==n.name&&async function(t){var r=t.closest(".submit_wrapper").querySelector(".loadergif");r.classList.remove("hidden");var a=t.closest("form");if(a.querySelectorAll(".hidden [required], select[required]").forEach((e=>{e.required=!1})),a.reportValidity()){var n=new FormData(a),o=await e("save_2fa_settings",n);o&&(a.querySelectorAll('[id^="setup-"]:not(.hidden)').forEach((e=>e.classList.add("hidden"))),Main.displayMessage(o,"success"),t.closest("form").querySelector(".form_submit").classList.add("hidden"))}r.classList.add("hidden")}(n),"email-code-button"==n.id&&async function(t){var r=`<img id='loader' src='${sim.loadingGif}' style='height:30px;margin-top:-6px;float:right;'>`;document.getElementById("email-message").innerHTML=`Sending e-mail... ${r}`;var a=document.getElementById("username").value,n=new FormData;n.append("username",a);var o=await e("request_email_code",n);o&&(document.getElementById("email-message").innerHTML=o,document.getElementById("email-message").classList.add("success"),document.getElementById("email-code-validation").classList.remove("hidden"),t.classList.add("hidden"),t.closest("form").querySelector(".form_submit").classList.remove("hidden"),document.getElementById("email-code-validation").focus())}(n)}))})();
//# sourceMappingURL=2fa.min.js.map