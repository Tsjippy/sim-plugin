<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conditional UI</title>
    <script>
      window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(
              result => {
                if (!result) {
                  console.log("No platform authenticator found. If your OS does not come with one, try using devtools to set one up.");
                }
              }
      );


      let abortController;
      let abortSignal;

      let startConditionalRequest = async () => {
        if (window.PublicKeyCredential.isConditionalMediationAvailable) {
          console.log("Conditional UI is understood by the browser");
          if (!await window.PublicKeyCredential.isConditionalMediationAvailable()) {
            console.log("Conditional UI is understood by your browser but not available");
            return;
          }
        } else {
          if (!navigator.credentials.conditionalMediationSupported) {
            console.log("Your browser does not implement Conditional UI (are you running the right chrome/safari version with the right flags?)");
            return;
          } else {
            console.log("This browser understand the old version of Conditional UI feature detection");
          }
        }
        abortController = new AbortController();
        abortSignal = abortController.signal;

        try {
          let credential = await window.navigator.credentials.get({
            //signal: abortSignal,
            publicKey: {
              // Don't do this in production!
              challenge: new Uint8Array([1, 2, 3, 4]),
              allowCredentials: [],
              rpId: 'simnigeria.org',
              timeout: 60000,
              userVerification: "preferred"
            },
            mediation: "conditional"
          });
          if (credential) {
            let username = String.fromCodePoint(...new Uint8Array(credential.response.userHandle));
            console.log(username);
          } else {
            console.log("Credential returned null");
          }
        } catch (error) {
          if (error.name == "AbortError") {
            console.log("request aborted");
            return;
          }
          console.log(error.toString());
        }
      }

      startConditionalRequest();
    </script>
  </head>
  <body>
    <form>
      <label for="login-username">Username:</label>
      <input name="username" id="login-username" value="" autocomplete="username webauthn" autofocus/>
      <label for="password">Fake password:</label>
      <input id="password" value="" required type="password" autocomplete="password webauthn"/>
      <div class="button-box">
        <button id="login" type="submit">
          <strong>Log-in</strong>
        </button>
      </div>
    </form>

    <div id="login_modal" class="modal" style='display:none'>
      <div class="modal-content">
        <div id='login_wrapper'>
            <h3>
                Login form
            </h3>
            <p class="message"><?php
                if(!empty($message)){echo $message;}
            ?></p>
            <form id="loginform" action="login" method="post">
                <input type='hidden' name='action' value='request_login'>

                <div id='usercred_wrapper'>
                    <label>
                        Username
                        <input id="username" type="text" class='wide' name="username" value="<?php echo $username;?>" autofocus required autocomplete="username webauthn" style='width: calc(100% - 40px);'>
                        <?php echo $imgSvg;?>
                    </label>

                    <div class="password">
                        <label>
                            Password
                            <input id="password" type="password" class='wide' name="password" required autocomplete="password webauthn">
                        </label>
                        <button type="button" class='toggle_pwd_view' data-toggle="0" title="Show password">
                            <img src="<?php echo PICTURESURL.'/invisible.png';?>" loading='lazy' alt='togglepasword'>
                        </button>
                    </div>
                    <div id='check_cred_wrapper'>
                        <label id='rememberme_label'>
                            <input name="rememberme" type="checkbox" id="rememberme" value="forever" checked>
                            Remember Me
                        </label>
                        <button type='button' id='check_cred' class='button'>Verify credentials</button>
                        <img class='loadergif hidden' src='<?php echo LOADERIMAGEURL;?>' loading='lazy' alt='loader'>
                    </div>
                </div>

                <div id='logging_in_wrapper' class='hidden'>
                    <h4 class='status_message'>Logging in...</h4>
                    <img class='loadergif center' src='<?php echo LOADERIMAGEURL; ?>' loading='lazy' alt='loader'>
                </div>

                <div id='webauthn_wrapper' class='authenticator_wrapper hidden'>
                    <h4 class='status_message'>Please authenticate...</h4>
                    <img class='loadergif center' src='<?php echo LOADERIMAGEURL; ?>' loading='lazy' alt='loader'>
                </div>

                <div id='authenticator_wrapper' class='authenticator_wrapper hidden'>
                    <label>
                        Please enter the two-factor authentication (2FA) verification code below to login.
                        <input type="tel" name="authcode"  class='wide' size="20" pattern="[0-9]*" required>
                    </label>
                </div>

                <div id='email_wrapper' class='authenticator_wrapper hidden'>
                    <label>
                        Please enter the code sent to your e-mail below to login.
                        <input type="tel" name="email_code"  class='wide' size="20" pattern="[0-9]*" required>
                    </label>
                </div>

                <div id='submit_login_wrapper' class='hidden'>
                    <div class='submit_wrapper'>
                    <button type='button' class='button' id='login_button' disabled>Login</button>
                    <img class='loadergif hidden' src='<?php echo LOADERIMAGEURL;?>' loading='lazy' alt='loader'>
                  </div>
                </div>
            </form>
            <form id="captcha-form" class='hidden'>
                <div id='captcha'>
                    <p>
                        First complete the captcha before sending the request.
                    </p>
                    <?php echo do_shortcode('[hcaptcha auto="true"]');?>
                </div>
                <a href='#pwd_reset' id='lost_pwd_link'>Request password reset</a>
            </form>
        </div>
      </div>
    </div>

  </body>
</html>