(()=>{console.log("Fileupload.js loaded");let e=0,t="",a="";function r(e,a){e.closest(".upload_div").querySelectorAll(".loadergif_wrapper").forEach((e=>{e.classList.remove("hidden"),e.querySelectorAll(".uploadmessage").forEach((e=>{e.textContent="Preparing upload",e.classList.add("upload-message")}))})),html=' \n\t<div id="progress-wrapper" class="hidden">\n\t\t<progress id="upload_progress" value="0" max="100"></progress>\n\t\t<span id="progress_percentage">   0%</span>\n\t</div>\n\t',t.insertAdjacentHTML("beforeEnd",html)}function o(e,a){var r=`\n\t<div class='document'>\n\t\t<input type='hidden' name='${t.querySelector(".file_upload").name.replace("_files","")}' value='${a}'>\n\t\t${e}\n\t\t<img class="remove_document_loader hidden" src="${sim.loadingGif}" style="height:40px;">\n\t</div>`;return t.querySelector(".documentpreview").insertAdjacentHTML("beforeend",r),t.querySelector(".documentpreview .document")}function s(a){if(a.lengthComputable){var r=a.total,o=100*a.loaded/r;o=Math.round(10*o)/10,document.getElementById("upload_progress").value=o,document.getElementById("progress_percentage").textContent=`   ${o}%`,o>=99&&(document.getElementById("progress-wrapper").remove(),t.querySelectorAll(".uploadmessage").forEach((t=>{t.textContent=e>1?"Processing documents":"Processing document"})))}}async function l(a){var r=new vimeoUploader.VimeoUpload(a),s=await r.tusUploader();if(!s)return t.querySelector(".file_upload").value="",document.getElementById("progress-wrapper").remove(),document.querySelector(".loadergif_wrapper:not(.hidden)").classList.add("hidden"),!1;if(e>1)var l="s";else l="";s.options.onProgress=function(e,t){var a=(e/t*100).toFixed(2);document.getElementById("upload_progress").value=a,document.getElementById("progress_percentage").textContent=`   ${a}%`,a>98&&(document.querySelector(".upload-message").textContent="Processing video"+l,document.getElementById("progress-wrapper").classList.add("hidden"))},s.options.onSuccess=async function(){var e=r.storedEntry.postId,s=new FormData;s.append("post_id",e);var l=new XMLHttpRequest;l.open("POST",sim.base_url+"/wp-json/sim/v1/vimeo/add_uploaded_vimeo",!1),l.send(s),document.getElementById("progress-wrapper").remove();var n=o(`\n\t\t<div class="vimeo-wrapper">\n\t\t\t<div class='vimeo-embed-container loading'>\n\t\t\t\t<iframe src='https://player.vimeo.com/video/${r.storedEntry.vimeoId}' frameborder='0' webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe><br>\n\t\t\t</div>\n\t\t</div>`,e);document.querySelector(".loadergif_wrapper:not(.hidden)").classList.add("hidden"),main.displayMessage(`The file ${a.name} has been uploaded succesfully.`,"success",!0),0==t.querySelector(".file_upload").multiple&&t.querySelector(".upload_div").classList.add("hidden"),t.querySelector(".file_upload").value="",r.urlStorage.removeUpload(r.storedEntry.urlStorageKey);var d=document.getElementById("postform");null!=d&&(d.querySelector('[name="update"]').value="true",d.querySelector('[name="post_id"]').value=e);for(var i="";!i.ok;)await new Promise((e=>setTimeout(e,1e4))),i=await fetch(`https://vimeo.com/api/oembed.json?url=https%3A//vimeo.com/${r.storedEntry.vimeoId}`,{method:"GET"});var u=await i.json();n.querySelector(".vimeo-wrapper").innerHTML=u.html},s.options.onError=function(e){console.error("Failed because: "+e)},document.querySelector(".upload-message").textContent="Uploading video"+l,document.getElementById("progress-wrapper").classList.remove("hidden"),s.start()}window.addEventListener("click",(function(e){var t=e.target;t.className.includes("remove_document")&&(e.preventDefault(),async function(e){var t=new FormData;for(var a in e.dataset)""!=e.dataset[a]&&t.append(a,e.dataset[a]);e.style.display="none",e.parentNode.classList.add("removethisdocument"),e.parentNode.querySelector(".remove_document_loader").classList.remove("hidden");var r=await formsubmit.fetchRestApi("remove_document",t);if(r){var o=e.closest(".document"),s=docwrapper.closest(".fileUploadWrap");docwrapper.querySelector(".remove_document_loader").classList.add("hidden");try{s.querySelector(".upload_div").classList.remove("hidden")}catch{document.querySelector('[name="post_image_id"]').value=""}o.remove();var l=new RegExp("(.*)[0-9](.*)","g");s.querySelectorAll(".file_url").forEach(((e,t)=>{e.name=e.name.replace(l,"$1"+t+"$2")})),main.displayMessage(r)}}(t))})),window.addEventListener("change",(n=>{var d=n.target;d.className.includes("file_upload")&&(n.preventDefault(),async function(n){t=n.closest(".fileUploadWrap");var d=new FormData;if(d.append("action","upload_files"),n.parentNode.querySelectorAll("input").forEach((function(e){d.append(e.name,e.value),a+=`data-${e.name}="${e.value}`})),e=n.files.length,e>0){for(var i=0;i<e;i++)if("video"==n.files[i].type.split("/")[0]&&"object"==typeof vimeoUploader)r(n),await l(n.files[i]);else{if(n.files[i].size>sim.max_file_size)return main.displayMessage("File too big, max file size is "+parseInt(sim.max_file_size)/1024/1024+"MB","error"),void(n.value="");d.append("files[]",n.files[i])}if(null!=d.get("files[]")){var u=new XMLHttpRequest;if(u.onreadystatechange=function(){4==u.readyState&&(u.status>=200&&u.status<400?function(e){for(var r=JSON.parse(e),s=0;s<imgurls.length;s++){var l=imgurls[s].url;null!=r[s].id&&(a+=' data-libraryid="'+imgurls[s].id+'"');var n=l.split("/")[l.split("/").length-1],d=sim.base_url+"/"+l;if(null==r[s].id)var i=d;else i=r[s].id;if(null!=l.toLowerCase().match(/\.(jpe|jpeg|jpg|gif|png)$/))var u=`<a class="fileupload" href="${d}"><img src="${d}" alt="picture" style="width:150px;height:150px;"></a>`;else u=`<a class="fileupload" href="${d}">${filename}</a>`;o(u+=`<button type="button" class="remove_document button" data-url="${l}" ${a}>X</button>`,i)}1==r.length?main.displayMessage(`The file ${n} has been uploaded succesfully.`,"success",!0):main.displayMessage("The files have been uploaded succesfully.","success",!0),0==t.querySelector(".file_upload").multiple&&t.querySelector(".upload_div").classList.add("hidden")}(u.responseText):main.displayMessage(JSON.parse(u.responseText).error,"error"),document.querySelectorAll(".loadergif_wrapper").forEach((function(e){e.classList.add("hidden")})),t.querySelector(".file_upload").value="")},u.upload.addEventListener("progress",s,!1),u.open("POST",sim.ajaxUrl,!0),r(n),e>1)var p="s";else p="";n.closest(".upload_div").querySelector(".uploadmessage").textContent="Uploading document"+p,document.getElementById("progress-wrapper").classList.remove("hidden"),u.send(d)}}else main.displayMessage("Please select some files before hitting the uplad button!","error")}(d))}))})();
//# sourceMappingURL=fileupload.min.js.map